name: Documentation Bot

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to generate docs for'
        required: true
        type: number

jobs:
  update-docs:
    # Only run if PR was actually merged (not just closed) OR manually triggered
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for analysis

      - name: Get merged PR information
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine if this is from PR event or manual trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            echo "Manual trigger - fetching PR #$PR_NUMBER info via gh CLI"

            # Get PR info using gh CLI
            PR_DATA=$(gh pr view $PR_NUMBER --json title,author,headRefOid,baseRefOid,mergeCommit)
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
            PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
            HEAD_SHA=$(echo "$PR_DATA" | jq -r '.headRefOid')
            BASE_SHA=$(echo "$PR_DATA" | jq -r '.baseRefOid')
          else
            echo "PR merge event - using event data"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT

          # Fetch PR commits via proper refs (survives branch deletion)
          # fetch-depth: 0 already fetched all history, but we may need the PR ref
          git fetch origin pull/$PR_NUMBER/head:refs/remotes/origin/pr-$PR_NUMBER || true

          # Get list of changed files
          git diff --name-only $BASE_SHA $HEAD_SHA > /tmp/changed_files.txt
          chmod +0777 /tmp/changed_files.txt
          echo "Changed files:"
          cat /tmp/changed_files.txt

          # Save changed files list for PR body
          CHANGED_FILES=$(cat /tmp/changed_files.txt)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code to Analyze & Generate Documentation
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          settings: |
            {
              "permissionMode": "permissive",
              "permissions": {
                "read": ["/tmp/changed_files.txt", "**/*.md", "**/*.go"],
                "write": ["**/*.md"],
                "edit": ["**/*.md"]
              }
            }
          additional_permissions: |
            {
              "read": ["/tmp/changed_files.txt", "**/*.md", "**/*.go"],
              "write": ["**/*.md"],
              "edit": ["**/*.md"]
            }
          prompt: |
            # ‚ö†Ô∏è CRITICAL RULES - READ FIRST ‚ö†Ô∏è

            ## ‚ùå ABSOLUTELY FORBIDDEN - WORKFLOW WILL FAIL:
            ‚ùå **NEVER create output.txt** - This file is STRICTLY FORBIDDEN
            ‚ùå **NEVER create ANY .txt files** - Only .md files allowed
            ‚ùå **NEVER create log files or temp files**
            ‚ùå **NEVER use Write tool on files that already exist**
            ‚ùå **NEVER skip updating existing documentation files**

            ## ‚úÖ ONLY THESE ACTIONS ARE ALLOWED:
            ‚úÖ Use Edit tool to UPDATE any existing .md files under docs/ folder and README.md
            ‚úÖ Use Write tool ONLY for .md files that don't exist yet
            ‚úÖ Use Glob/Bash tools to discover all .md files in docs/
            ‚úÖ Read tool to check file content and existence FIRST before any Edit/Write

            ---

            # Your Task

            PR #${{ steps.pr_info.outputs.pr_number }}: ${{ steps.pr_info.outputs.pr_title }}
            Author: @${{ steps.pr_info.outputs.pr_author }}

            ## Step-by-Step MANDATORY Workflow:

            ### Step 1: Read Changed Files
            ```
            1. Use Bash tool: ls -la docs/
            2. Use Glob tool: docs/**/*.md (to discover ALL markdown files)
            3. Use Read tool on each .md file found to understand current docs structure
            4. Use Read tool on each changed file from PR to understand what changed
            ```

            ### Step 2: Analyze Which Docs Need Updates
            Based on the PR changes and existing docs you just discovered:
            - Determine which documentation files are relevant to the PR changes
            - You MUST update ANY .md file that relates to the changes (not just a fixed list!)
            - Examples only (NOT requirements): docs/API.md, docs/ARCHITECTURE.md, docs/*_handlers.md, etc.
            - Choose files dynamically by matching PR changes to doc topics

            ### Step 3: Update ALL Relevant Documentation
            For EACH markdown file that needs updates:
            ```
            1. Use Read tool on the file (if you haven't already)
            2. Use Edit tool to update it (NOT Write - files exist!)
            3. Make comprehensive updates based on PR changes
            ```

            **CRITICAL RULES:**
            - Update ANY relevant .md files you discovered in Step 1 - not a fixed list!
            - ALWAYS use Edit tool for existing files (NOT Write!)
            - Match changes to docs: handler changes ‚Üí handler docs, model changes ‚Üí model docs, etc.
            - Always update README.md with high-level summary of changes

            ### Step 4: Documentation Requirements
            Make documentation COMPREHENSIVE and DETAILED:
            - VERBOSE, DETAILED content (not minimal summaries)
            - COMPLETE code examples (not just snippets)
            - Tables for structured data (props, fields, parameters)
            - Collapsible sections for long examples
            - Mermaid diagrams for architecture/flows
            - Cross-references to related documentation
            - "Last updated" timestamp in each file
            - Request/response examples for ALL API endpoints
            - Error responses and status codes
            - Code examples in multiple languages (cURL, Go, Python where applicable)

            ## Final Reminder:
            - ‚ùå DO NOT create output.txt or ANY temp files
            - ‚úÖ ONLY modify .md files in docs/ folder and README.md
            - ‚úÖ Use Edit for existing files, Write for new files only
            - Make changes even if they seem small - let git detect if there are real changes

      - name: Verify no forbidden files created
        run: |
          # Check if output.txt or other forbidden files were created
          if [ -f "output.txt" ]; then
            echo "‚ùå ERROR: output.txt was created (forbidden!)"
            echo "Bot did not follow instructions properly"
            exit 1
          fi

          if git status --short | grep -qE "\.txt$|\.log$"; then
            echo "‚ùå ERROR: Text or log files were created (forbidden!)"
            git status --short | grep -E "\.txt$|\.log$"
            exit 1
          fi

          echo "‚úÖ No forbidden files detected"

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Validate generated documentation
        continue-on-error: true
        run: |
          # Basic formatting check (only if docs exist)
          if compgen -G "docs/**/*.md" > /dev/null 2>&1; then
            markdownlint --fix docs/**/*.md || true
          fi

          # Fix README if it exists
          if [ -f README.md ]; then
            markdownlint --fix README.md || true
          fi

      - name: Check if documentation was updated
        id: check_changes
        run: |
          # Check if Claude modified any documentation files
          if git status --short | grep -qE "(docs/.*\.md|README\.md)"; then
            echo "needs_pr=true" >> $GITHUB_OUTPUT
            echo "üìù Documentation changes detected!"
            echo ""
            echo "Modified files:"
            git status --short | grep -E "(docs/.*\.md|README\.md)"

            # Capture modified files for PR body
            MODIFIED_FILES=$(git status --short | grep -E "(docs/.*\.md|README\.md)")
            echo "modified_files<<EOF" >> $GITHUB_OUTPUT
            echo "$MODIFIED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "needs_pr=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No documentation changes were made (docs are already current)."
          fi

      - name: Create Documentation PR
        if: steps.check_changes.outputs.needs_pr == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: Update documentation for PR #${{ steps.pr_info.outputs.pr_number }}

            Auto-generated comprehensive documentation based on:
            ${{ steps.pr_info.outputs.pr_title }}

            Merged by: @${{ steps.pr_info.outputs.pr_author }}

            ü§ñ Auto-generated documentation
          branch: docs/update-pr-${{ steps.pr_info.outputs.pr_number }}
          delete-branch: true
          title: "üìö docs: Update for PR #${{ steps.pr_info.outputs.pr_number }}"
          body: |
            ## üìù Documentation Update

            This PR contains documentation updates based on changes merged in **PR #${{ steps.pr_info.outputs.pr_number }}**.

            ### Original PR

            - **Title:** ${{ steps.pr_info.outputs.pr_title }}
            - **Author:** @${{ steps.pr_info.outputs.pr_author }}
            - **Link:** #${{ steps.pr_info.outputs.pr_number }}

            ### Changes Included

            Documentation has been generated/updated based on analysis of all related modules:

            ```
            ${{ steps.pr_info.outputs.changed_files }}
            ```

            ### Files Modified

            ```
            ${{ steps.check_changes.outputs.modified_files }}
            ```

            ---

            ### üìã Review Checklist for Docs Team

            - [ ] **Technical Accuracy** - Verify all technical details are correct
            - [ ] **Code Examples** - Test that code examples actually work
            - [ ] **Completeness** - All relevant aspects are documented
            - [ ] **Links** - All internal and external links work
            - [ ] **Formatting** - Markdown renders correctly
            - [ ] **Clarity** - Documentation is easy to understand
            - [ ] **No Sensitive Data** - No API keys, secrets, or internal URLs

            ---

            ü§ñ **Auto-generated documentation**

            /cc @docs-team
          labels: |
            documentation
            needs-review
            auto-generated
          # Note: team-reviewers only works in organization repos with a visible team
          # For personal repos, remove this line or use 'reviewers' instead
          # team-reviewers: |
          #   docs-team
          # For personal repos, uncomment this instead:
          # reviewers: |
          #   your-username
          draft: false

      - name: Add comment to PR
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_pr.outputs.pull-request-number }},
              body: `## üéâ Documentation PR Created!

            **What's in this PR:**
            - Comprehensive markdown documentation
            - Generated by analyzing PR #${{ steps.pr_info.outputs.pr_number }} and all related modules
            - Verbose, detailed content with examples

            **Next Steps:**
            1. Review the generated documentation
            2. Test any code examples
            3. Approve and merge when satisfied

            **Feedback:** If you find issues, comment on specific lines in the "Files changed" tab.`
            });

      - name: Summary
        if: always()
        run: |
          echo "## Documentation Bot Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** PR #${{ steps.pr_info.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation needed:** ${{ steps.check_changes.outputs.needs_pr }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.needs_pr }}" == "true" ]; then
            echo "- **Documentation PR:** #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PR URL:** ${{ steps.create_pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Action:** No PR created (docs are current)" >> $GITHUB_STEP_SUMMARY
          fi
