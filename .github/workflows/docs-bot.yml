name: Documentation Bot

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to generate docs for'
        required: true
        type: number

jobs:
  update-docs:
    # Only run if PR was actually merged (not just closed) OR manually triggered
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for analysis

      - name: Get merged PR information
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine if this is from PR event or manual trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            echo "Manual trigger - fetching PR #$PR_NUMBER info via gh CLI"

            # Get PR info using gh CLI
            PR_DATA=$(gh pr view $PR_NUMBER --json title,author,headRefOid,baseRefOid,mergeCommit)
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
            PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
            HEAD_SHA=$(echo "$PR_DATA" | jq -r '.headRefOid')
            BASE_SHA=$(echo "$PR_DATA" | jq -r '.baseRefOid')
          else
            echo "PR merge event - using event data"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT

          # Fetch PR commits via proper refs (survives branch deletion)
          # fetch-depth: 0 already fetched all history, but we may need the PR ref
          git fetch origin pull/$PR_NUMBER/head:refs/remotes/origin/pr-$PR_NUMBER || true

          # Get list of changed files
          git diff --name-only $BASE_SHA $HEAD_SHA > /tmp/changed_files.txt
          chmod +0777 /tmp/changed_files.txt
          echo "Changed files:"
          cat /tmp/changed_files.txt

          # Save changed files list for PR body
          CHANGED_FILES=$(cat /tmp/changed_files.txt)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code to Analyze & Generate Documentation
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          additional_permissions: |
            {
              "read": ["/tmp/changed_files.txt", "docs/**/*.md", "README.md", "internal/**/*.go", "cmd/**/*.go"],
              "write": ["docs/**/*.md", "README.md"],
              "edit": ["docs/**/*.md", "README.md"]
            }
          prompt: |
            # ‚ö†Ô∏è CRITICAL RULES - READ FIRST ‚ö†Ô∏è

            ## FORBIDDEN ACTIONS (You will FAIL if you do these):
            ‚ùå DO NOT create output.txt
            ‚ùå DO NOT create log files or temp files
            ‚ùå DO NOT use Write tool on existing files
            ‚ùå DO NOT skip updating existing documentation files

            ## ALLOWED ACTIONS ONLY:
            ‚úÖ Use Edit tool to UPDATE existing .md files
            ‚úÖ Use Write tool ONLY for NEW files that don't exist
            ‚úÖ ONLY modify these files: docs/API.md, docs/ARCHITECTURE.md, docs/DATA_MODELS.md, README.md

            ---

            # Your Task

            PR #${{ steps.pr_info.outputs.pr_number }}: ${{ steps.pr_info.outputs.pr_title }}
            Author: @${{ steps.pr_info.outputs.pr_author }}

            ## Step-by-Step Instructions (Follow in order):

            ### Step 1: Analyze Changes
            1. Use Read tool on `/tmp/changed_files.txt` to see what changed
            2. Use Read tool on each changed file to understand the changes
            3. Identify related Go modules and dependencies

            ### Step 2: Check Existing Documentation
            Use Read tool to check and read these files (use absolute paths from pwd):
            1. `docs/API.md`
            2. `docs/ARCHITECTURE.md`
            3. `docs/DATA_MODELS.md`
            4. `README.md`

            You MUST use Read tool on EACH file to determine if it exists before deciding to use Edit or Write.

            ### Step 3: Update Documentation Files

            For EACH file above that EXISTS:
            - ‚úÖ Use Edit tool to update it with new information
            - Add/update sections relevant to PR changes
            - Keep existing content, just enhance/update it

            For EACH file that does NOT exist:
            - ‚úÖ Use Write tool to create it from scratch

            ### Step 4: Documentation Requirements
            - Use VERBOSE, DETAILED content (not minimal)
            - Include COMPLETE code examples (not snippets)
            - Add tables for structured data
            - Include mermaid diagrams where appropriate
            - Add "Last updated" timestamp
            - Show request/response examples for APIs
            - Include error responses

            ## Final Reminder:
            - ‚ùå DO NOT create output.txt or ANY temp files
            - ‚úÖ ONLY modify .md files in docs/ folder and README.md
            - ‚úÖ Use Edit for existing files, Write for new files only
            - Make changes even if they seem small - let git detect if there are real changes

      - name: Verify no forbidden files created
        run: |
          # Check if output.txt or other forbidden files were created
          if [ -f "output.txt" ]; then
            echo "‚ùå ERROR: output.txt was created (forbidden!)"
            echo "Bot did not follow instructions properly"
            exit 1
          fi

          if git status --short | grep -qE "\.txt$|\.log$"; then
            echo "‚ùå ERROR: Text or log files were created (forbidden!)"
            git status --short | grep -E "\.txt$|\.log$"
            exit 1
          fi

          echo "‚úÖ No forbidden files detected"

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Validate generated documentation
        continue-on-error: true
        run: |
          # Basic formatting check (only if docs exist)
          if compgen -G "docs/**/*.md" > /dev/null 2>&1; then
            markdownlint --fix docs/**/*.md || true
          fi

          # Fix README if it exists
          if [ -f README.md ]; then
            markdownlint --fix README.md || true
          fi

      - name: Check if documentation was updated
        id: check_changes
        run: |
          # Check if Claude modified any documentation files
          if git status --short | grep -qE "(docs/.*\.md|README\.md)"; then
            echo "needs_pr=true" >> $GITHUB_OUTPUT
            echo "üìù Documentation changes detected!"
            echo ""
            echo "Modified files:"
            git status --short | grep -E "(docs/.*\.md|README\.md)"

            # Capture modified files for PR body
            MODIFIED_FILES=$(git status --short | grep -E "(docs/.*\.md|README\.md)")
            echo "modified_files<<EOF" >> $GITHUB_OUTPUT
            echo "$MODIFIED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "needs_pr=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No documentation changes were made (docs are already current)."
          fi

      - name: Create Documentation PR
        if: steps.check_changes.outputs.needs_pr == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: Update documentation for PR #${{ steps.pr_info.outputs.pr_number }}

            Auto-generated comprehensive documentation based on:
            ${{ steps.pr_info.outputs.pr_title }}

            Merged by: @${{ steps.pr_info.outputs.pr_author }}

            ü§ñ Auto-generated documentation
          branch: docs/update-pr-${{ steps.pr_info.outputs.pr_number }}
          delete-branch: true
          title: "üìö docs: Update for PR #${{ steps.pr_info.outputs.pr_number }}"
          body: |
            ## üìù Documentation Update

            This PR contains documentation updates based on changes merged in **PR #${{ steps.pr_info.outputs.pr_number }}**.

            ### Original PR

            - **Title:** ${{ steps.pr_info.outputs.pr_title }}
            - **Author:** @${{ steps.pr_info.outputs.pr_author }}
            - **Link:** #${{ steps.pr_info.outputs.pr_number }}

            ### Changes Included

            Documentation has been generated/updated based on analysis of all related modules:

            ```
            ${{ steps.pr_info.outputs.changed_files }}
            ```

            ### Files Modified

            ```
            ${{ steps.check_changes.outputs.modified_files }}
            ```

            ---

            ### üìã Review Checklist for Docs Team

            - [ ] **Technical Accuracy** - Verify all technical details are correct
            - [ ] **Code Examples** - Test that code examples actually work
            - [ ] **Completeness** - All relevant aspects are documented
            - [ ] **Links** - All internal and external links work
            - [ ] **Formatting** - Markdown renders correctly
            - [ ] **Clarity** - Documentation is easy to understand
            - [ ] **No Sensitive Data** - No API keys, secrets, or internal URLs

            ---

            ü§ñ **Auto-generated documentation**

            /cc @docs-team
          labels: |
            documentation
            needs-review
            auto-generated
          # Note: team-reviewers only works in organization repos with a visible team
          # For personal repos, remove this line or use 'reviewers' instead
          # team-reviewers: |
          #   docs-team
          # For personal repos, uncomment this instead:
          # reviewers: |
          #   your-username
          draft: false

      - name: Add comment to PR
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_pr.outputs.pull-request-number }},
              body: `## üéâ Documentation PR Created!

            **What's in this PR:**
            - Comprehensive markdown documentation
            - Generated by analyzing PR #${{ steps.pr_info.outputs.pr_number }} and all related modules
            - Verbose, detailed content with examples

            **Next Steps:**
            1. Review the generated documentation
            2. Test any code examples
            3. Approve and merge when satisfied

            **Feedback:** If you find issues, comment on specific lines in the "Files changed" tab.`
            });

      - name: Summary
        if: always()
        run: |
          echo "## Documentation Bot Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** PR #${{ steps.pr_info.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation needed:** ${{ steps.check_changes.outputs.needs_pr }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.needs_pr }}" == "true" ]; then
            echo "- **Documentation PR:** #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PR URL:** ${{ steps.create_pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Action:** No PR created (docs are current)" >> $GITHUB_STEP_SUMMARY
          fi
